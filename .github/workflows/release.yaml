name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Install go-ignore-cov
        run: go install github.com/quantumcycle/go-ignore-cov@v0.6.1

      - name: Run tests with coverage
        run: task ci:test

      - name: Run filtered coverage (repository package)
        run: |
          echo "=== Repository Package Filtered Coverage ==="
          go test -coverprofile=coverage.out ./internal/adapters/repository/...
          go-ignore-cov -f coverage.out -o coverage.filtered.out -r "$(pwd)"
          echo ""
          echo "Raw coverage:"
          go tool cover -func=coverage.out | tail -1
          echo ""
          echo "Filtered coverage (excluding //coverage:ignore):"
          go tool cover -func=coverage.filtered.out | tail -1

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  build:
    name: Build binaries
    needs: [test, lint]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: darwin
            goarch: amd64
            name: darwin-amd64
          - goos: darwin
            goarch: arm64
            name: darwin-arm64
          - goos: linux
            goarch: amd64
            name: linux-amd64
          - goos: linux
            goarch: arm64
            name: linux-arm64
          - goos: android
            goarch: arm64
            name: android-arm64
            cgo: true
          - goos: linux
            goarch: arm
            goarm: "7"
            name: linux-armv7
          - goos: windows
            goarch: amd64
            name: windows-amd64
            ext: .exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Setup Android NDK
        if: matrix.cgo == true
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: ${{ matrix.cgo == true && '1' || '0' }}
          CC: ${{ matrix.cgo == true && format('{0}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang', steps.setup-ndk.outputs.ndk-path) || '' }}
          CXX: ${{ matrix.cgo == true && format('{0}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang++', steps.setup-ndk.outputs.ndk-path) || '' }}
        run: task ci:build OUTPUT=dist/k1s-${{ matrix.name }}${{ matrix.ext }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: k1s-${{ matrix.name }}
          path: dist/k1s-${{ matrix.name }}${{ matrix.ext }}

  package:
    name: Create Linux packages
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            binary: linux-amd64
          - arch: arm64
            binary: linux-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: k1s-${{ matrix.binary }}
          path: dist

      - name: Install nFPM
        run: |
          NFPM_VERSION=$(curl -s https://api.github.com/repos/goreleaser/nfpm/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          curl -sfL "https://github.com/goreleaser/nfpm/releases/download/v${NFPM_VERSION}/nfpm_${NFPM_VERSION}_Linux_x86_64.tar.gz" | tar xz -C /tmp
          sudo mv /tmp/nfpm /usr/local/bin/

      - name: Build .deb package
        env:
          VERSION: ${{ github.ref_name }}
          GOARCH: ${{ matrix.arch }}
          BINARY: ${{ matrix.binary }}
        run: task ci:package:deb ARCH=${{ matrix.arch }}

      - name: Build .rpm package
        env:
          VERSION: ${{ github.ref_name }}
          GOARCH: ${{ matrix.arch }}
          BINARY: ${{ matrix.binary }}
        run: task ci:package:rpm ARCH=${{ matrix.arch }}

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: k1s-deb-${{ matrix.arch }}
          path: dist/*.deb

      - name: Upload rpm artifact
        uses: actions/upload-artifact@v4
        with:
          name: k1s-rpm-${{ matrix.arch }}
          path: dist/*.rpm

  release:
    name: Create Release
    needs: [build, package]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: List artifacts
        run: ls -la dist/

      - name: Create checksums
        run: task ci:checksums

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            dist/k1s-darwin-amd64
            dist/k1s-darwin-arm64
            dist/k1s-linux-amd64
            dist/k1s-linux-arm64
            dist/k1s-android-arm64
            dist/k1s-linux-armv7
            dist/k1s-windows-amd64.exe
            dist/*.deb
            dist/*.rpm
            dist/checksums.txt
          body: |
            ## k1s ${{ github.ref_name }}

            Kubernetes TUI Debugger - One screen to see why your pod is broken.

            ### Downloads

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | macOS | Intel (amd64) | `k1s-darwin-amd64` |
            | macOS | Apple Silicon (arm64) | `k1s-darwin-arm64` |
            | Linux | x86_64 (amd64) | `k1s-linux-amd64` |
            | Linux | ARM64 | `k1s-linux-arm64` |
            | Linux | ARMv7 (Raspberry Pi) | `k1s-linux-armv7` |
            | Android | Termux (arm64) | `k1s-android-arm64` |
            | Windows | x86_64 (amd64) | `k1s-windows-amd64.exe` |
            | Debian/Ubuntu | x86_64 | `k1s_${{ steps.version.outputs.VERSION }}_amd64.deb` |
            | Debian/Ubuntu | ARM64 | `k1s_${{ steps.version.outputs.VERSION }}_arm64.deb` |
            | RHEL/Fedora | x86_64 | `k1s-${{ steps.version.outputs.VERSION }}-1.amd64.rpm` |
            | RHEL/Fedora | ARM64 | `k1s-${{ steps.version.outputs.VERSION }}-1.arm64.rpm` |

            ### Installation

            **macOS/Linux (Homebrew):**
            ```bash
            brew tap andrebassi/k1s
            brew install k1s
            ```

            **Windows (Scoop):**
            ```powershell
            scoop bucket add k1s https://github.com/andrebassi/scoop-k1s
            scoop install k1s
            ```

            **Arch Linux (AUR):**
            ```bash
            yay -S k1s-bin
            ```

            **Debian/Ubuntu (.deb):**
            ```bash
            curl -LO https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/k1s_${{ steps.version.outputs.VERSION }}_amd64.deb
            sudo apt install ./k1s_${{ steps.version.outputs.VERSION }}_amd64.deb
            ```

            **RHEL/Fedora/CentOS (.rpm):**
            ```bash
            curl -LO https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/k1s-${{ steps.version.outputs.VERSION }}-1.amd64.rpm
            sudo dnf install ./k1s-${{ steps.version.outputs.VERSION }}-1.amd64.rpm
            ```

            **Android (Termux):**
            ```bash
            curl -L -o $PREFIX/bin/k1s https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/k1s-android-arm64
            chmod +x $PREFIX/bin/k1s
            ```

            **Manual (Linux/macOS):**
            ```bash
            curl -L -o k1s https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/k1s-linux-amd64
            chmod +x k1s
            sudo mv k1s /usr/local/bin/
            ```

            ### Verify checksums

            ```bash
            sha256sum -c checksums.txt
            ```

  homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout homebrew tap
        uses: actions/checkout@v4
        with:
          repository: andrebassi/homebrew-k1s
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-k1s

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Download checksums
        run: |
          curl -L -o checksums.txt https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/checksums.txt
          cat checksums.txt

      - name: Get SHA256 sums
        id: sha
        run: |
          echo "DARWIN_AMD64=$(grep darwin-amd64 checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "DARWIN_ARM64=$(grep darwin-arm64 checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "LINUX_AMD64=$(grep linux-amd64 checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "LINUX_ARM64=$(grep linux-arm64 checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Update Homebrew formula
        run: |
          mkdir -p homebrew-k1s/Formula
          cat > homebrew-k1s/Formula/k1s.rb << 'EOF'
          class K1s < Formula
            desc "Kubernetes TUI Debugger - One screen to see why your pod is broken"
            homepage "https://github.com/andrebassi/k1s"
            version "${{ steps.version.outputs.VERSION }}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/k1s-darwin-arm64"
                sha256 "${{ steps.sha.outputs.DARWIN_ARM64 }}"
              else
                url "https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/k1s-darwin-amd64"
                sha256 "${{ steps.sha.outputs.DARWIN_AMD64 }}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/k1s-linux-arm64"
                sha256 "${{ steps.sha.outputs.LINUX_ARM64 }}"
              else
                url "https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/k1s-linux-amd64"
                sha256 "${{ steps.sha.outputs.LINUX_AMD64 }}"
              end
            end

            def install
              bin.install Dir["k1s*"].first => "k1s"
            end

            test do
              assert_match "k1s version", shell_output("#{bin}/k1s --version")
            end
          end
          EOF

      - name: Commit and push
        run: |
          cd homebrew-k1s
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/k1s.rb
          git commit -m "Update k1s to ${{ github.ref_name }}" || echo "No changes to commit"
          git push

  scoop:
    name: Update Scoop Bucket
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout scoop bucket
        uses: actions/checkout@v4
        with:
          repository: andrebassi/scoop-k1s
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: scoop-k1s

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Download checksums
        run: |
          curl -L -o checksums.txt https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/checksums.txt
          cat checksums.txt

      - name: Get SHA256 sum
        id: sha
        run: |
          echo "WINDOWS_AMD64=$(grep windows-amd64 checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Update Scoop manifest
        run: |
          cat > scoop-k1s/bucket/k1s.json << EOF
          {
              "version": "${{ steps.version.outputs.VERSION }}",
              "description": "Kubernetes TUI Debugger - One screen to see why your pod is broken",
              "homepage": "https://github.com/andrebassi/k1s",
              "license": "MIT",
              "architecture": {
                  "64bit": {
                      "url": "https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/k1s-windows-amd64.exe#/k1s.exe",
                      "hash": "${{ steps.sha.outputs.WINDOWS_AMD64 }}"
                  }
              },
              "bin": "k1s.exe",
              "checkver": {
                  "github": "https://github.com/andrebassi/k1s"
              },
              "autoupdate": {
                  "architecture": {
                      "64bit": {
                          "url": "https://github.com/andrebassi/k1s/releases/download/v\$version/k1s-windows-amd64.exe#/k1s.exe"
                      }
                  }
              }
          }
          EOF

      - name: Commit and push
        run: |
          cd scoop-k1s
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bucket/k1s.json
          git commit -m "Update k1s to ${{ github.ref_name }}" || echo "No changes to commit"
          git push

  chocolatey:
    name: Publish to Chocolatey
    needs: release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Download checksums
        shell: bash
        run: |
          curl -L -o checksums.txt https://github.com/andrebassi/k1s/releases/download/${{ github.ref_name }}/checksums.txt
          cat checksums.txt

      - name: Get SHA256 sum
        id: sha
        shell: bash
        run: |
          echo "WINDOWS_AMD64=$(grep windows-amd64 checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Update nuspec version
        shell: pwsh
        run: |
          $nuspec = Get-Content chocolatey/k1s.nuspec -Raw
          $nuspec = $nuspec -replace '<version>.*</version>', '<version>${{ steps.version.outputs.VERSION }}</version>'
          Set-Content chocolatey/k1s.nuspec $nuspec

      - name: Update install script
        shell: pwsh
        run: |
          $install = Get-Content chocolatey/tools/chocolateyinstall.ps1 -Raw
          $install = $install -replace "\`$version = '.*'", "`$version = '${{ steps.version.outputs.VERSION }}'"
          $install = $install -replace "checksum64\s*=\s*'.*'", "checksum64    = '${{ steps.sha.outputs.WINDOWS_AMD64 }}'"
          Set-Content chocolatey/tools/chocolateyinstall.ps1 $install

      - name: Pack Chocolatey package
        shell: pwsh
        run: |
          cd chocolatey
          choco pack

      - name: Push to Chocolatey
        shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          cd chocolatey
          # Try to push, but don't fail if package is pending moderation
          $output = choco push k1s.${{ steps.version.outputs.VERSION }}.nupkg --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY 2>&1
          $exitCode = $LASTEXITCODE
          Write-Host $output

          if ($exitCode -ne 0) {
            if ($output -match "previous version in a submitted state") {
              Write-Host "::warning::Chocolatey package k1s has a version pending moderation. Skipping push."
              exit 0
            } else {
              Write-Host "::error::Failed to push to Chocolatey"
              exit $exitCode
            }
          }
